name: Sync Theme Branches

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'templates/*.json'
      - 'config/*.json'
      - 'sections/*.json'
  pull_request:
    types: [closed]
    branches:
      - main
    paths-ignore:
      - 'templates/*.json'
      - 'config/*.json'
      - 'sections/*.json'

jobs:
  sync-stores:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        store: [live/site2]  # Add your store branches here: [live/US, live/CA]
      fail-fast: false  # Continue with other stores if one fails

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better merge resolution

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Checkout target branch
        run: |
          git checkout -b ${{ matrix.store }} origin/${{ matrix.store }}

      - name: Merge main into ${{ matrix.store }}
        id: merge
        run: |
          # Check if there are any conflicts before merging
          git merge --no-commit --no-ff main || {
            echo "Merge conflict detected, attempting to resolve..."
            git merge --abort
            echo "::error::Merge conflict in ${{ matrix.store }} branch"
            exit 1
          }

          # Perform the actual merge
          git merge --no-ff main -m "Auto-sync from main branch [skip ci]"

          # Push the updated branch
          git push origin ${{ matrix.store }}

      - name: Verify merge
        run: |
          # Check if the merge was successful
          git log --oneline -5

      - name: Notify success
        if: success()
        run: |
          echo "✅ Successfully synced ${{ matrix.store }} with main branch"

      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Failed to sync ${{ matrix.store }} with main branch"
          echo "Please check for merge conflicts and resolve manually"