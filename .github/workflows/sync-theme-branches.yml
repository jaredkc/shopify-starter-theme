name: Sync main to Store Branches via PR

on:
  pull_request:
    types: [opened]
    branches:
      - main

jobs:
  sync-stores:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        store: [live/site2] # Add more store branches as needed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Always create the sync branch locally from the target branch, do NOT try to fetch it from remote
      - name: Create sync branch from ${{ matrix.store }}
        run: |
          git fetch origin
          git checkout origin/${{ matrix.store }}
          git checkout -b sync/main-to-${{ matrix.store }}

      - name: Merge main into sync branch
        run: |
          git fetch origin main
          git merge --no-ff origin/main -m "Sync main into ${{ matrix.store }} [skip ci]" || true

      - name: Remove ignored files from merge
        run: |
          git restore --staged config/markets.json || true
          git restore --staged config/settings_data.json || true
          git restore --staged 'sections/**/*.json' || true
          git restore --staged 'templates/*.json' || true

          git checkout -- config/markets.json || true
          git checkout -- config/settings_data.json || true
          git checkout -- 'sections/**/*.json' || true
          git checkout -- 'templates/*.json' || true

      - name: Commit changes (if any)
        run: |
          git add .
          git diff --cached --quiet || git commit -m "Sync main into ${{ matrix.store }} (excluding ignored files)"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: sync/main-to-${{ matrix.store }}
          base: ${{ matrix.store }}
          title: "Sync main into ${{ matrix.store }} (excluding ignored files)"
          body: |
            This PR was created automatically by a workflow to sync changes from main into ${{ matrix.store }}, **excluding** the following files:
            - config/markets.json
            - config/settings_data.json
            - sections/**/*.json
            - templates/*.json

      - name: Cleanup sync branch (optional)
        if: always()
        run: |
          git checkout ${{ matrix.store }}
          git branch -D sync/main-to-${{ matrix.store }} || true